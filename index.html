<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#080c18">
<title>KPI Quiz</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap');

:root {
  --bg: #080c18;
  --s1: #0e1525;
  --s2: #151e30;
  --s3: #1c2840;
  --border: #1e2d45;
  --border2: #263550;
  --accent: #38bdf8;
  --accent2: #f97316;
  --green: #34d399;
  --red: #f87171;
  --yellow: #fbbf24;
  --text: #e2eaf7;
  --muted: #4d6585;
  --muted2: #7a96b5;
  --fd: 'Syne', sans-serif;
  --fm: 'JetBrains Mono', monospace;
}

*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:var(--fm);font-size:14px}

/* bg glow */
body::before{
  content:'';position:fixed;inset:0;
  background:radial-gradient(ellipse 60% 40% at 80% 10%,rgba(56,189,248,.05),transparent),
             radial-gradient(ellipse 50% 50% at 20% 90%,rgba(249,115,22,.04),transparent);
  pointer-events:none
}

/* layout */
#wrap{position:relative;z-index:1;max-width:500px;margin:0 auto;height:100%;display:flex;flex-direction:column}

/* header */
header{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 16px 10px;flex-shrink:0
}
.logo{font-family:var(--fd);font-weight:800;font-size:18px;letter-spacing:-0.5px}
.logo b{color:var(--accent)}
.streak-pill{
  display:flex;align-items:center;gap:5px;
  background:rgba(249,115,22,.12);border:1px solid rgba(249,115,22,.25);
  border-radius:20px;padding:5px 12px;
  font-family:var(--fd);font-weight:700;font-size:13px;color:var(--accent2)
}

/* tabs */
.tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;padding:0 16px}
.tab{
  flex:1;padding:10px 4px;background:none;border:none;border-bottom:2px solid transparent;
  color:var(--muted2);font-family:var(--fd);font-weight:600;font-size:12px;letter-spacing:.5px;
  cursor:pointer;transition:.2s;margin-bottom:-1px
}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* content */
.content{flex:1;overflow-y:auto;padding:14px 16px 24px}
.screen{display:none}
.screen.active{display:block;animation:fi .25s ease}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* cards */
.card{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px}
.card-head{font-family:var(--fd);font-weight:700;font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted2);margin-bottom:12px}

/* stat grid */
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.sbox{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
.snum{font-family:var(--fd);font-weight:800;font-size:26px;color:var(--accent)}
.slbl{font-size:10px;color:var(--muted);margin-top:2px}

/* buttons */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:7px;
  border:none;border-radius:10px;font-family:var(--fd);font-weight:700;font-size:13px;
  cursor:pointer;transition:all .15s;padding:12px 18px;width:100%
}
.btn:active{transform:scale(.97)}
.btn-blue{background:var(--accent);color:#07111f}
.btn-ghost{background:var(--s2);color:var(--text);border:1px solid var(--border)}
.btn-ghost:hover{border-color:var(--border2)}
.btn-red{background:rgba(248,113,113,.12);color:var(--red);border:1px solid rgba(248,113,113,.25)}
.btn-sm{padding:7px 12px;font-size:11px;width:auto;border-radius:8px}
.btn-green{background:var(--green);color:#07111f}

/* form */
label{display:block;font-size:10px;letter-spacing:.5px;color:var(--muted2);margin-bottom:5px}
input,select{
  width:100%;background:var(--s2);border:1px solid var(--border);border-radius:9px;
  color:var(--text);font-family:var(--fm);font-size:13px;padding:10px 12px;outline:none;
  transition:border-color .2s;margin-bottom:12px;-webkit-appearance:none
}
input:focus,select:focus{border-color:var(--accent)}
select option{background:var(--s1)}

/* â”€â”€ DATA ENTRY â”€â”€ */
.metric-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 12px;background:var(--s2);border:1px solid var(--border);
  border-radius:9px;margin-bottom:6px;cursor:pointer;transition:.15s
}
.metric-row:hover{border-color:var(--border2)}
.metric-name{font-family:var(--fd);font-weight:600;font-size:13px}
.metric-meta{font-size:11px;color:var(--muted)}
.metric-badge{font-size:10px;color:var(--accent);background:rgba(56,189,248,.1);border-radius:5px;padding:2px 7px}

/* month grid */
.mgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:14px}
.mcell{background:var(--s3);border:1px solid var(--border);border-radius:8px;padding:6px}
.mcell-label{font-size:9px;color:var(--muted);text-align:center;margin-bottom:4px;letter-spacing:.5px}
.mcell input{
  background:transparent;border:none;border-bottom:1px solid var(--border2);
  border-radius:0;padding:4px 2px;text-align:center;font-size:13px;font-weight:500;
  margin-bottom:0;width:100%
}
.mcell input:focus{border-bottom-color:var(--accent);outline:none}
.mcell input.has-val{color:var(--green)}

/* fixed items (deÄŸiÅŸmez veriler) */
.fixed-items{display:none;margin-bottom:14px}
.fixed-items.show{display:block}
.fixed-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.fixed-row input{flex:1;margin-bottom:0}
.fixed-row .btn.btn-sm{padding:8px 12px;flex-shrink:0}
.metric-type-select{margin-bottom:12px}
.paste-zone-12{margin-bottom:10px}
.paste-zone-12 input{font-size:12px;margin-bottom:6px}

/* â”€â”€ QUIZ â”€â”€ */
.qmeta{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;font-size:11px;color:var(--muted2)}
.pbbar{height:3px;background:var(--border);border-radius:2px;margin-bottom:20px;overflow:hidden}
.pbfill{height:100%;background:var(--accent);transition:width .4s ease}
.q-tag{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--accent2);margin-bottom:6px}
.q-text{font-family:var(--fd);font-size:21px;font-weight:700;line-height:1.3;margin-bottom:24px}

.ans-row{display:flex;gap:8px;margin-bottom:14px}
.ans-row input{
  flex:1;margin-bottom:0;font-size:20px;text-align:center;
  letter-spacing:1px;border-radius:10px;padding:13px
}
.ans-row .btn{width:auto;padding:13px 18px;flex-shrink:0}

.result{border-radius:10px;padding:14px 16px;margin-bottom:14px;display:none}
.result.ok{background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.25)}
.result.bad{background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.25)}
.result-lbl{font-family:var(--fd);font-weight:700;font-size:13px;margin-bottom:3px}
.result-lbl.ok{color:var(--green)}
.result-lbl.bad{color:var(--red)}
.result-ans{font-size:19px;font-weight:500}

.diff-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;display:none}
.dbtn{padding:11px 6px;border-radius:9px;border:none;font-family:var(--fd);font-weight:700;font-size:11px;cursor:pointer;transition:.15s}
.dbtn:active{transform:scale(.95)}
.d-hard{background:rgba(248,113,113,.12);color:var(--red);border:1px solid rgba(248,113,113,.25)}
.d-med{background:rgba(251,191,36,.12);color:var(--yellow);border:1px solid rgba(251,191,36,.25)}
.d-easy{background:rgba(52,211,153,.12);color:var(--green);border:1px solid rgba(52,211,153,.25)}

.no-q{text-align:center;padding:50px 20px;color:var(--muted)}
.no-q .icon{font-size:44px;margin-bottom:14px}
.no-q h3{font-family:var(--fd);font-size:17px;color:var(--text);margin-bottom:7px}

.done-screen{text-align:center;padding:36px 20px}
.done-icon{font-size:56px;margin-bottom:14px}
.done-title{font-family:var(--fd);font-weight:800;font-size:26px;margin-bottom:6px}
.done-sub{color:var(--muted2);font-size:12px;margin-bottom:26px}

/* modal */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:200;display:none;align-items:flex-end}
.overlay.open{display:flex}
.modal{background:var(--s1);border:1px solid var(--border);border-radius:20px 20px 0 0;padding:20px;width:100%;max-height:90vh;overflow-y:auto;animation:su .3s ease}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:3px;background:var(--border);border-radius:2px;margin:0 auto 18px}
.modal-title{font-family:var(--fd);font-weight:700;font-size:17px;margin-bottom:16px}

/* stats */
.stat-line{display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:var(--s2);border-radius:8px;margin-bottom:5px;font-size:12px}
.sl-q{color:var(--text);flex:1}
.sl-v{color:var(--accent);font-weight:500;margin:0 10px}
.sl-due{font-size:10px}

.chip{display:inline-block;padding:3px 8px;border-radius:5px;font-size:10px;font-weight:600;font-family:var(--fd)}
.chip-new{background:rgba(56,189,248,.12);color:var(--accent)}
.chip-rev{background:rgba(251,191,36,.12);color:var(--yellow)}

/* reset confirm */
.reset-section{margin-top:10px;padding-top:14px;border-top:1px solid var(--border)}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="logo">KPI<b>Quiz</b></div>
    <div class="streak-pill">ğŸ”¥ <span id="streakNum">0</span></div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="showTab('home')">Ana Sayfa</button>
    <button class="tab" onclick="showTab('data')">Veriler</button>
    <button class="tab" onclick="showTab('quiz')">Quiz</button>
    <button class="tab" onclick="showTab('stats')">Ä°statistik</button>
  </div>

  <div class="content">

    <!-- HOME -->
    <div class="screen active" id="tab-home">
      <div class="sgrid">
        <div class="sbox"><div class="snum" id="hTotal">0</div><div class="slbl">Toplam Soru</div></div>
        <div class="sbox"><div class="snum" id="hDue">0</div><div class="slbl">BugÃ¼n Bekleyen</div></div>
        <div class="sbox"><div class="snum" id="hLearned">0</div><div class="slbl">Ã–ÄŸrenildi</div></div>
        <div class="sbox"><div class="snum" id="hAcc">â€”</div><div class="slbl">BaÅŸarÄ± %</div></div>
      </div>
      <div class="card">
        <div class="card-head">BugÃ¼nkÃ¼ Seans</div>
        <p style="font-size:12px;color:var(--muted2);margin-bottom:14px" id="hSub">Veri sekmesinden metrik ekle.</p>
        <button class="btn btn-blue" onclick="showTab('quiz')">â–¶ Teste BaÅŸla</button>
      </div>
      <div class="card reset-section">
        <div class="card-head">Ã–ÄŸrenme SÄ±fÄ±rlama</div>
        <p style="font-size:12px;color:var(--muted2);margin-bottom:12px">TÃ¼m sorularÄ±n Ã¶ÄŸrenme geÃ§miÅŸini sÄ±fÄ±rla â€” sanki hiÃ§ quiz yapmamÄ±ÅŸ gibi yeniden baÅŸla.</p>
        <button class="btn btn-red" onclick="confirmReset()">â†º TÃ¼m Ä°lerlemeyi SÄ±fÄ±rla</button>
      </div>
    </div>

    <!-- DATA -->
    <div class="screen" id="tab-data">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <div style="font-family:var(--fd);font-weight:700;font-size:16px">Metrikler</div>
        <button class="btn btn-blue btn-sm" onclick="openAddMetric()">+ Yeni Metrik</button>
      </div>
      <div id="metricList"></div>
    </div>

    <!-- QUIZ -->
    <div class="screen" id="tab-quiz">
      <div id="quizArea"></div>
    </div>

    <!-- STATS -->
    <div class="screen" id="tab-stats">
      <div class="card">
        <div class="card-head">Son Seanslar</div>
        <div id="sessionList"></div>
      </div>
      <div class="card">
        <div class="card-head">Soru DurumlarÄ±</div>
        <div id="qStatusList"></div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /wrap -->

<!-- MODAL: Add/Edit Metric -->
<div class="overlay" id="metricModal" onclick="overlayClose(event,'metricModal')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="mmTitle">Yeni Metrik</div>
    <label>METRÄ°K ADI</label>
    <input id="mName" placeholder="Ã–rn: Doluluk OranÄ±, Makine tamir sÄ±klÄ±ÄŸÄ±, Personel maaÅŸÄ±">
    <label>BÄ°RÄ°M (opsiyonel)</label>
    <input id="mUnit" placeholder="Ã–rn: %, TL, sayÄ± â€” boÅŸ bÄ±rakabilirsin">
    <label>VERÄ° TÄ°PÄ°</label>
    <select id="mType" class="metric-type-select" onchange="toggleMetricType()">
      <option value="12month">12 aylÄ± veriler</option>
      <option value="fixed">DeÄŸiÅŸmez veriler</option>
    </select>
    <div id="m12Block">
      <label>YIL</label>
      <select id="mYear"></select>
      <label>AYLIK DEÄERLER</label>
      <div class="paste-zone-12">
        <input type="text" id="paste12Input" placeholder="12 deÄŸeri buraya yapÄ±ÅŸtÄ±r â†’ Ocakâ€¦AralÄ±k sÄ±rasÄ±yla aylara daÄŸÄ±lÄ±r" onpaste="handleExcelPaste(event)">
      </div>
      <div class="mgrid" id="monthGrid"></div>
    </div>
    <div id="mFixedBlock" class="fixed-items" onpaste="handleFixedPaste(event)">
      <label>VERÄ° Ä°KÄ°LÄ°LERÄ° (deÄŸiÅŸken adÄ± + deÄŸer) â€” Excel'den yapÄ±ÅŸtÄ±rabilirsin</label>
      <div id="fixedItemsList"></div>
      <button type="button" class="btn btn-ghost btn-sm" onclick="addFixedRow()">+ SatÄ±r ekle</button>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('metricModal')">Ä°ptal</button>
      <button class="btn btn-blue" style="flex:1" onclick="saveMetric()">Kaydet</button>
    </div>
  </div>
</div>

<!-- MODAL: Reset confirm -->
<div class="overlay" id="resetModal" onclick="overlayClose(event,'resetModal')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Ä°lerlemeyi SÄ±fÄ±rla</div>
    <p style="font-size:13px;color:var(--muted2);margin-bottom:20px;line-height:1.6">
      TÃ¼m sorularÄ±n SM-2 verileri silinecek. Soru ve deÄŸerlerin korunur, sadece Ã¶ÄŸrenme sÃ¼reci sÄ±fÄ±rlanÄ±r.
    </p>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('resetModal')">VazgeÃ§</button>
      <button class="btn btn-red" style="flex:1" onclick="doReset()">Evet, SÄ±fÄ±rla</button>
    </div>
  </div>
</div>

<!-- MODAL: Metric detail (edit/delete) -->
<div class="overlay" id="detailModal" onclick="overlayClose(event,'detailModal')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="dmTitle"></div>
    <div class="mgrid" id="dmGrid"></div>
    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="btn btn-ghost btn-sm" style="flex:1" onclick="editMetric()">âœ DÃ¼zenle</button>
      <button class="btn btn-red btn-sm" style="flex:1" onclick="deleteMetric()">ğŸ—‘ Sil</button>
    </div>
    <div style="margin-top:8px">
      <button class="btn btn-ghost" onclick="resetMetric()">â†º Bu metriÄŸi sÄ±fÄ±rla</button>
    </div>
    <div style="margin-top:8px">
      <button class="btn btn-ghost" onclick="closeModal('detailModal')">Kapat</button>
    </div>
  </div>
</div>

<script>
const MONTHS = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
const MONTH_SHORT = ['Oca','Åub','Mar','Nis','May','Haz','Tem','AÄŸu','Eyl','Eki','Kas','Ara'];

// â”€â”€ DATA MODEL â”€â”€
// metrics: type '12month' => {id, name, unit, type:'12month', year, values[12], sm2[12]}
//          type 'fixed'   => {id, name, unit, type:'fixed', items:[{name,value}], sm2[items.length]}
// sessions: [{date, correct, wrong}]
let metrics = [];
let sessions = [];
let streak = 0;

// quiz runtime: card = { metricIdx, valueIdx, isFixed } (valueIdx = monthIdx or itemIdx)
let quizQueue = [];
let currentCard = null;
let sessionC = 0, sessionW = 0;
let editingMetricId = null;
let detailMetricId = null;

// â”€â”€ SM-2 â”€â”€
function defaultSM2(){ return {ef:2.5,interval:0,reps:0,nextReview:Date.now()} }
function isDue(sm2){ return (sm2?.nextReview||0) <= Date.now() }
function sm2Calc(sm2, q){ // q: 0=hard,1=med,2=easy
  let {ef,interval,reps} = sm2;
  if(q===0){reps=0;interval=1;}
  else{
    if(reps===0) interval=1;
    else if(reps===1) interval=3;
    else interval=Math.round(interval*ef);
    reps++;
    ef=Math.max(1.3,ef+0.1-(2-q)*(0.08+(2-q)*0.02));
  }
  return {ef,interval,reps,nextReview:Date.now()+interval*86400000};
}

// â”€â”€ STORAGE â”€â”€
async function persist(){
  try{
    await window.storage.set('metrics2',JSON.stringify(metrics));
    await window.storage.set('sessions2',JSON.stringify(sessions));
    await window.storage.set('streak2',String(streak));
  }catch(e){}
}
async function hydrate(){
  try{
    const m=await window.storage.get('metrics2');
    if(m){
      metrics=JSON.parse(m.value);
      metrics.forEach(m=>{
        if(!m.type) m.type='12month';
        if(m.type==='fixed' && !m.items) m.items=[];
      });
    }
    const s=await window.storage.get('sessions2');
    if(s) sessions=JSON.parse(s.value);
    const st=await window.storage.get('streak2');
    if(st) streak=parseInt(st.value)||0;
  }catch(e){}
  refreshAll();
}

// â”€â”€ TABS â”€â”€
function showTab(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  [...document.querySelectorAll('.tab')].find(t=>t.textContent.includes(
    name==='home'?'Ana':name==='data'?'Veri':name==='quiz'?'Quiz':'Ä°sta'
  ))?.classList.add('active');
  if(name==='home') renderHome();
  if(name==='data') renderData();
  if(name==='quiz') startQuiz();
  if(name==='stats') renderStats();
}

// â”€â”€ HOME â”€â”€
function allCards(){
  const cards=[];
  metrics.forEach((m,mi)=>{
    if(m.type==='fixed'){
      const items=m.items||[];
      if(!m.sm2) m.sm2=items.map(()=>defaultSM2());
      items.forEach((it,i)=>{ if((it.value||'').toString().trim()!=='') cards.push({metricIdx:mi,valueIdx:i,isFixed:true}); });
    } else {
      if(!m.sm2) m.sm2=Array(12).fill(null).map(defaultSM2);
      (m.values||[]).forEach((v,vi)=>{
        if(v===''||v===null||v===undefined) return;
        cards.push({metricIdx:mi,valueIdx:vi,isFixed:false});
      });
    }
  });
  return cards;
}
function renderHome(){
  const all=allCards();
  const due=all.filter(c=>isDue(metrics[c.metricIdx].sm2[c.valueIdx]));
  const learned=all.filter(c=>metrics[c.metricIdx].sm2[c.valueIdx]?.reps>=3);
  const tc=sessions.reduce((a,s)=>a+s.correct,0);
  const tw=sessions.reduce((a,s)=>a+s.wrong,0);
  const acc=tc+tw>0?Math.round(tc/(tc+tw)*100):null;
  document.getElementById('hTotal').textContent=all.length;
  document.getElementById('hDue').textContent=due.length;
  document.getElementById('hLearned').textContent=learned.length;
  document.getElementById('hAcc').textContent=acc!==null?acc+'%':'â€”';
  document.getElementById('streakNum').textContent=streak;
  document.getElementById('hSub').textContent=
    all.length===0?'Veri sekmesinden metrik ekle.':
    due.length>0?`${due.length} soru tekrar zamanÄ± geldi.`:
    'TÃ¼m sorular gÃ¼ncel! Yeni veri ekleyebilirsin.';
}

// â”€â”€ DATA â”€â”€
function renderData(){
  const el=document.getElementById('metricList');
  if(metrics.length===0){
    el.innerHTML='<div style="text-align:center;padding:40px 20px;color:var(--muted);font-size:13px">HenÃ¼z metrik yok.<br>+ Yeni Metrik ile baÅŸla.</div>';
    return;
  }
  el.innerHTML=metrics.map(m=>{
    const isFixed=m.type==='fixed';
    const filled=isFixed?(m.items||[]).length:(m.values||[]).filter(v=>v!==''&&v!==null&&v!==undefined).length;
    const meta=isFixed?`DeÄŸiÅŸmez Â· ${filled} ikili`:(`${m.year||'â€”'} Â· ${filled}/12 ay`);
    return `<div class="metric-row" onclick="openDetail('${m.id}')">
      <div>
        <div class="metric-name">${m.name}${m.unit?' <span style="color:var(--muted);font-size:11px">(${m.unit})</span>':''}</div>
        <div class="metric-meta">${meta}</div>
      </div>
      <span class="metric-badge">${filled} soru</span>
    </div>`;
  }).join('');
}

// â”€â”€ MODAL: ADD METRIC â”€â”€
function openAddMetric(){
  editingMetricId=null;
  document.getElementById('mmTitle').textContent='Yeni Metrik';
  document.getElementById('mName').value='';
  document.getElementById('mUnit').value='';
  document.getElementById('mType').value='12month';
  toggleMetricType();
  buildYearSelect();
  buildMonthGrid(Array(12).fill(''));
  buildFixedItems([]);
  openModal('metricModal');
}
function toggleMetricType(){
  const type=document.getElementById('mType').value;
  const is12=type==='12month';
  document.getElementById('m12Block').style.display=is12?'block':'none';
  const fix=document.getElementById('mFixedBlock');
  fix.style.display=is12?'none':'block';
  if(is12) fix.classList.remove('show'); else fix.classList.add('show');
}
function buildFixedItems(items){
  const el=document.getElementById('fixedItemsList');
  el.innerHTML=items.map((it,i)=>`
    <div class="fixed-row">
      <input type="text" placeholder="DeÄŸiÅŸken adÄ±" value="${(it.name||'').replace(/"/g,'&quot;')}">
      <input type="text" inputmode="decimal" placeholder="DeÄŸer" value="${(it.value||'').replace(/"/g,'&quot;')}">
      <button type="button" class="btn btn-red btn-sm" onclick="removeFixedRow(this)" title="Sil">âœ•</button>
    </div>`).join('');
}
function handleFixedPaste(e){
  const text=(e.clipboardData||window.clipboardData).getData('text');
  const lines=text.trim().split(/\r?\n/).map(l=>l.split(/\t/).map(s=>s.trim()));
  const pairs=lines.filter(parts=>parts.length>=1).map(parts=>({name:parts[0]||'',value:parts.length>=2?parts[1]:''}));
  if(pairs.length<1) return;
  e.preventDefault();
  buildFixedItems(pairs);
}
function addFixedRow(){
  const list=document.getElementById('fixedItemsList');
  const div=document.createElement('div');
  div.className='fixed-row';
  div.innerHTML=`<input type="text" placeholder="DeÄŸiÅŸken adÄ±" value="">
    <input type="text" inputmode="decimal" placeholder="DeÄŸer" value="">
    <button type="button" class="btn btn-red btn-sm" onclick="removeFixedRow(this)" title="Sil">âœ•</button>`;
  list.appendChild(div);
}
function removeFixedRow(btn){
  btn.closest('.fixed-row').remove();
}
function buildYearSelect(){
  const sel=document.getElementById('mYear');
  const cur=new Date().getFullYear();
  sel.innerHTML=[cur-1,cur,cur+1].map(y=>`<option value="${y}">${y}</option>`).join('');
  sel.value=cur;
}
function buildMonthGrid(vals){
  document.getElementById('monthGrid').innerHTML=MONTH_SHORT.map((m,i)=>`
    <div class="mcell">
      <div class="mcell-label">${m}</div>
      <input type="text" inputmode="decimal" id="mv${i}" value="${vals[i]||''}"
        class="${vals[i]?'has-val':''}"
        oninput="this.className=this.value?'has-val':''"
        onpaste="handleExcelPaste(event)"
        placeholder="â€”">
    </div>`).join('');
}
function handleExcelPaste(e){
  const text=(e.clipboardData||window.clipboardData).getData('text');
  const parts=text.split(/[\t\n\r]+/).map(p=>p.trim()).filter(p=>p!=='');
  if(parts.length<12) return;
  e.preventDefault();
  for(let i=0;i<12;i++){
    const input=document.getElementById('mv'+i);
    if(!input) continue;
    const val=parts[i]||'';
    input.value=val;
    input.className=val?'has-val':'';
  }
  const pasteBox=document.getElementById('paste12Input');
  if(pasteBox) pasteBox.value='';
}
function saveMetric(){
  const name=document.getElementById('mName').value.trim();
  const unit=document.getElementById('mUnit').value.trim();
  const type=document.getElementById('mType').value;
  if(!name){alert('Metrik adÄ± zorunlu');return;}

  if(type==='fixed'){
    const rows=document.querySelectorAll('#fixedItemsList .fixed-row');
    const items=[];
    rows.forEach(r=>{
      const inputs=r.querySelectorAll('input');
      const n=(inputs[0]&&inputs[0].value.trim())||'';
      const v=(inputs[1]&&inputs[1].value.trim())||'';
      if(n||v) items.push({name:n,value:v});
    });
    if(items.length===0){alert('En az bir veri ikilisi ekleyin (deÄŸiÅŸken adÄ± + deÄŸer).');return;}
    if(editingMetricId){
      const m=metrics.find(m=>m.id===editingMetricId);
      if(m){ m.name=name; m.unit=unit; m.type='fixed'; m.items=items; m.sm2=items.map((_,i)=>m.sm2&&m.sm2[i]?m.sm2[i]:defaultSM2()); }
    } else {
      metrics.push({ id:Date.now().toString(), name, unit, type:'fixed', items, sm2:items.map(()=>defaultSM2()) });
    }
  } else {
    const year=parseInt(document.getElementById('mYear').value);
    const vals=Array.from({length:12},(_,i)=>document.getElementById('mv'+i).value.trim());
    if(editingMetricId){
      const m=metrics.find(m=>m.id===editingMetricId);
      if(m){
        m.name=name;m.unit=unit;m.year=year;m.type='12month';
        vals.forEach((v,i)=>{
          if(v!==m.values[i]){ m.values[i]=v; if(!m.sm2) m.sm2=Array(12).fill(null).map(defaultSM2); m.sm2[i]=defaultSM2(); }
        });
      }
    } else {
      metrics.push({ id:Date.now().toString(), name, unit, type:'12month', year, values:vals, sm2:Array(12).fill(null).map(defaultSM2) });
    }
  }
  persist();closeModal('metricModal');renderData();renderHome();
}

// â”€â”€ MODAL: DETAIL â”€â”€
function openDetail(id){
  detailMetricId=id;
  const m=metrics.find(m=>m.id===id);
  document.getElementById('dmTitle').textContent=m.type==='fixed'?m.name:`${m.name} ${m.year}`;
  const dmGrid=document.getElementById('dmGrid');
  if(m.type==='fixed'){
    const items=m.items||[];
    dmGrid.innerHTML=items.length?items.map(it=>`
      <div class="stat-line" style="margin-bottom:6px">
        <span class="sl-q">${it.name||'â€”'}</span>
        <span class="sl-v">${it.value||'â€”'}</span>
      </div>`).join(''):'<div style="color:var(--muted);font-size:12px">Veri ikilisi yok.</div>';
    dmGrid.className='';
  } else {
    dmGrid.className='mgrid';
    dmGrid.innerHTML=MONTH_SHORT.map((mn,i)=>`
      <div class="mcell" style="cursor:default">
        <div class="mcell-label">${mn}</div>
        <div style="text-align:center;font-size:13px;padding:4px 2px;font-weight:500;color:${m.values[i]?'var(--green)':'var(--muted)'}">
          ${m.values[i]||'â€”'}
        </div>
      </div>`).join('');
  }
  openModal('detailModal');
}
function editMetric(){
  closeModal('detailModal');
  const m=metrics.find(m=>m.id===detailMetricId);
  editingMetricId=detailMetricId;
  document.getElementById('mmTitle').textContent='MetriÄŸi DÃ¼zenle';
  document.getElementById('mName').value=m.name;
  document.getElementById('mUnit').value=m.unit||'';
  document.getElementById('mType').value=m.type==='fixed'?'fixed':'12month';
  buildYearSelect();
  document.getElementById('mYear').value=m.year||new Date().getFullYear();
  buildMonthGrid(m.type==='12month'?(m.values||[]):Array(12).fill(''));
  buildFixedItems(m.type==='fixed'?(m.items||[]):[]);
  toggleMetricType();
  openModal('metricModal');
}
function deleteMetric(){
  if(!confirm('Bu metriÄŸi silmek istiyor musun?')) return;
  metrics=metrics.filter(m=>m.id!==detailMetricId);
  persist();closeModal('detailModal');renderData();renderHome();
}
function resetMetric(){
  const m=metrics.find(m=>m.id===detailMetricId);
  if(m) m.sm2=(m.type==='fixed'?(m.items||[]):Array(12)).map(()=>defaultSM2());
  persist();closeModal('detailModal');renderHome();alert('Bu metriÄŸin Ã¶ÄŸrenme geÃ§miÅŸi sÄ±fÄ±rlandÄ±.');
}

// â”€â”€ RESET ALL â”€â”€
function confirmReset(){ openModal('resetModal'); }
function doReset(){
  metrics.forEach(m=>{ m.sm2=(m.type==='fixed'?(m.items||[]):Array(12)).map(()=>defaultSM2()); });
  sessions=[];streak=0;
  persist();closeModal('resetModal');refreshAll();
  alert('TÃ¼m ilerleme sÄ±fÄ±rlandÄ±.');
}

// â”€â”€ QUIZ â”€â”€
function startQuiz(){
  sessionC=0;sessionW=0;
  quizQueue=[];
  const cards=allCards();
  cards.forEach(c=>{ if(isDue(metrics[c.metricIdx].sm2[c.valueIdx])) quizQueue.push(c); });
  for(let i=quizQueue.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));[quizQueue[i],quizQueue[j]]=[quizQueue[j],quizQueue[i]];
  }
  if(quizQueue.length===0){
    document.getElementById('quizArea').innerHTML=`
      <div class="no-q">
        <div class="icon">âœ…</div>
        <h3>BugÃ¼n tamamlandÄ±!</h3>
        <p style="font-size:12px;margin-top:6px">TÃ¼m sorular gÃ¼ncel. Yeni veri ekle veya bekle.</p>
      </div>`;
    return;
  }
  nextQ();
}

function nextQ(){
  if(quizQueue.length===0){ showDone(); return; }
  const card=quizQueue.shift();
  currentCard=card;
  const m=metrics[card.metricIdx];
  const isFixed=card.isFixed;
  const tag=isFixed?m.name:m.year+' Â· '+MONTHS[card.valueIdx];
  const qText=isFixed?(m.items[card.valueIdx].name+(m.unit?' ('+m.unit+')':'')):(m.name+(m.unit?' ('+m.unit+')':''));
  const total=sessionC+sessionW+quizQueue.length+1;
  const done=sessionC+sessionW;
  const pct=total>0?(done/total)*100:0;
  const sm2=m.sm2[card.valueIdx];

  document.getElementById('quizArea').innerHTML=`
    <div class="qmeta">
      <span>${done+1} / ${total}</span>
      <span class="chip ${sm2.reps===0?'chip-new':'chip-rev'}">${sm2.reps===0?'YENÄ°':'TEKRAR'}</span>
    </div>
    <div class="pbbar"><div class="pbfill" style="width:${pct}%"></div></div>
    <div class="q-tag">${tag}</div>
    <div class="q-text">${qText}</div>
    <div class="ans-row">
      <input type="text" id="aInput" inputmode="decimal" placeholder="CevabÄ±n..."
        onkeydown="if(event.key==='Enter')checkAns()">
      <button class="btn btn-blue" style="width:auto;padding:13px 16px" onclick="checkAns()">â†’</button>
    </div>
    <div class="result" id="res">
      <div class="result-lbl" id="resLbl"></div>
      <div class="result-ans" id="resAns"></div>
    </div>
    <div class="diff-row" id="drow">
      <button class="dbtn d-hard" onclick="rate(0)">ğŸ˜“ Zor</button>
      <button class="dbtn d-med" onclick="rate(1)">ğŸ¤” Orta</button>
      <button class="dbtn d-easy" onclick="rate(2)">ğŸ˜Š Kolay</button>
    </div>`;
  document.getElementById('aInput').focus();
}

function checkAns(){
  const inp=document.getElementById('aInput');
  const user=inp.value.trim().replace(',','.');
  const m=metrics[currentCard.metricIdx];
  const ans=currentCard.isFixed?m.items[currentCard.valueIdx].value:m.values[currentCard.valueIdx];
  const correct=String(ans).trim().replace(',','.');
  const ok=user===correct;

  inp.disabled=true;
  const res=document.getElementById('res');
  res.style.display='block';
  res.className='result '+(ok?'ok':'bad');
  document.getElementById('resLbl').textContent=ok?'âœ… DoÄŸru!':'âŒ YanlÄ±ÅŸ';
  document.getElementById('resLbl').className='result-lbl '+(ok?'ok':'bad');
  document.getElementById('resAns').textContent=ok?ans:`DoÄŸru: ${ans}${m.unit?' '+m.unit:''}`;

  if(ok) sessionC++; else sessionW++;
  document.getElementById('drow').style.display='grid';
}

function rate(q){
  const m=metrics[currentCard.metricIdx];
  m.sm2[currentCard.valueIdx]=sm2Calc(m.sm2[currentCard.valueIdx],q);
  if(q===0) quizQueue.push(currentCard);
  persist();
  nextQ();
}

function showDone(){
  // save session
  const today=new Date().toDateString();
  const ex=sessions.find(s=>s.date===today);
  if(ex){ex.correct+=sessionC;ex.wrong+=sessionW;}
  else sessions.push({date:today,correct:sessionC,wrong:sessionW});
  // streak
  const yest=new Date(Date.now()-86400000).toDateString();
  if(sessions.some(s=>s.date===yest)||sessions.length===1) streak++;
  persist();
  document.getElementById('streakNum').textContent=streak;
  const total=sessionC+sessionW;
  const acc=total>0?Math.round(sessionC/total*100):0;
  document.getElementById('quizArea').innerHTML=`
    <div class="done-screen">
      <div class="done-icon">${acc>=80?'ğŸ†':acc>=60?'ğŸ‘':'ğŸ’ª'}</div>
      <div class="done-title">Seans Tamam!</div>
      <div class="done-sub">${sessionC} doÄŸru Â· ${sessionW} yanlÄ±ÅŸ Â· %${acc} baÅŸarÄ±</div>
      <div class="sgrid">
        <div class="sbox"><div class="snum" style="color:var(--green)">${sessionC}</div><div class="slbl">DoÄŸru</div></div>
        <div class="sbox"><div class="snum" style="color:var(--red)">${sessionW}</div><div class="slbl">YanlÄ±ÅŸ</div></div>
      </div>
      <button class="btn btn-blue" style="margin-top:16px" onclick="showTab('home')">Ana Sayfaya DÃ¶n</button>
    </div>`;
  renderHome();
}

// â”€â”€ STATS â”€â”€
function renderStats(){
  // sessions
  const sl=document.getElementById('sessionList');
  if(sessions.length===0){sl.innerHTML='<div style="color:var(--muted);font-size:12px">HenÃ¼z seans yok.</div>';}
  else{
    sl.innerHTML=[...sessions].reverse().slice(0,7).map(s=>{
      const total=s.correct+s.wrong;
      const acc=total>0?Math.round(s.correct/total*100):0;
      const d=new Date(s.date);
      return `<div class="stat-line">
        <span class="sl-q">${d.toLocaleDateString('tr-TR',{day:'numeric',month:'short',year:'numeric'})}</span>
        <span style="font-size:11px;color:var(--muted2)">${s.correct}D/${s.wrong}Y</span>
        <span style="color:${acc>=70?'var(--green)':'var(--red)'};font-weight:700;font-size:13px">%${acc}</span>
      </div>`;
    }).join('');
  }
  // question statuses
  const ql=document.getElementById('qStatusList');
  const cards=allCards();
  if(cards.length===0){ql.innerHTML='<div style="color:var(--muted);font-size:12px">Soru yok.</div>';return;}
  ql.innerHTML=cards.slice(0,20).map(c=>{
    const m=metrics[c.metricIdx];
    const sm2=m.sm2[c.valueIdx];
    const due=isDue(sm2);
    const dt=new Date(sm2.nextReview);
    const label=due?'Åimdi':dt.toLocaleDateString('tr-TR',{day:'numeric',month:'short'});
    const sub=c.isFixed?m.items[c.valueIdx].name:`${MONTH_SHORT[c.valueIdx]} ${m.year}`;
    const val=c.isFixed?m.items[c.valueIdx].value:m.values[c.valueIdx];
    return `<div class="stat-line">
      <span class="sl-q" style="font-size:11px">${m.name} â€” ${sub}</span>
      <span class="sl-v">${val}</span>
      <span class="sl-due" style="color:${due?'var(--accent2)':'var(--muted)'}">${label}</span>
    </div>`;
  }).join('');
}

// â”€â”€ MODAL HELPERS â”€â”€
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function overlayClose(e,id){ if(e.target===document.getElementById(id)) closeModal(id); }

// â”€â”€ INIT â”€â”€
function refreshAll(){ renderHome();renderData();renderStats(); }
hydrate();
</script>
</body>
</html>
